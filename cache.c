#include<stdio.h>
#include<time.h>
#include<stdlib.h>

/*** 64Byte record***/
typedef struct _record{
  union {
    struct {
      struct _record *next;
      struct _record *prev;
      int i[2];
    } strct;
    unsigned long long x[8]; // 64 byte
  };
} record;

int main(int argc, char **argv)
{
  if (argc < 2) {
    printf("Usage: %s <Size of Array>\n", argv[0]);
    printf("Example: %s $((1 << 3))\n", argv[0]);
    exit(1);
  }

  unsigned long long size = (unsigned long long)atoi(argv[1]);
  asm volatile(".align 64");
  record p[size];
  record *ptr, *tmp, *chk;
  unsigned long long i, j, idx; 
  struct timespec ts1, ts2;
  
  /*** initialize array, creating cyclic list ***/
  ptr = p;
  for (i = 0; i < size; i++) {
    ptr->strct.next = ptr + 1;
    ptr->strct.prev = ptr - 1;
    ptr++;
  }
  ptr--; 
  ptr->strct.next = p;
  p->strct.prev = ptr;

  /*** randomize the list ***/
  ptr = p;
  srand((unsigned)time(NULL));
  for (i = 0; i < size; i++) {
    while (1) { 
      idx = (unsigned long long int)rand() % size; //selected index
      chk = p + idx;
      if (ptr != chk && ptr->strct.next != chk && ptr->strct.prev != chk) {
	break;
      }
    }
    tmp = ptr->strct.next;
    ptr->strct.next = p + idx;
    ptr->strct.prev->strct.next = tmp;
    ptr->strct.next->strct.prev->strct.next = ptr;
    tmp->strct.prev = ptr->strct.prev;
    ptr->strct.prev = ptr->strct.next->strct.prev;
    ptr->strct.next->strct.prev = ptr;
    ptr++;
  }

  /**** measure the latency ****/
  asm volatile("// Start");
  //  asm volatile("rdtsc": "=A" (t1)); 
  clock_gettime(CLOCK_THREAD_CPUTIME_ID, &ts1);
  ptr = p;
  for (j = 0; j < size; j++) {
    ptr->strct.i[0] = 0;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
    ptr = ptr->strct.next;
  }
  //  asm volatile("rdtsc": "=A" (t2));
  clock_gettime(CLOCK_THREAD_CPUTIME_ID, &ts2);
  asm volatile("// End");


  printf("%lld elements takes %lf cycles on average\n", size, (double)(2.40*1000000000*(ts2.tv_sec - ts1.tv_sec + (double)(ts2.tv_nsec - ts1.tv_nsec)/1000000000.0)/size/512.0));

  return 0;
}
